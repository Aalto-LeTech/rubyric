<!-- reviews/edit.html.erb -->
<% content_for :javascript do %>
  <%= javascript_include_tag 'reviews-edit' %>
<% end %>

<%= form_for @review do |f| %>
  <%= f.hidden_field :payload %>
  <%= f.hidden_field :status %>
  <%= f.hidden_field :grade %>

  <div class="tabbable review-editor" id="review-editor" data-rubric-url="<%= exercise_rubric_url(@exercise.id) %>" data-review-url="<%= review_url(@review.id) %>">
    <ul id="tabs" class="nav nav-tabs">
      <li class="active"><a href="#tab-overview" data-toggle="tab">Overview</a></li>
      
      <!-- ko foreach: pages -->
        <li><a data-bind="text:name, attr:{ href: '#page-' + id }" data-toggle='tab'></a></li>
      <!-- /ko -->
      
      <!-- ko if: finishable -->
        <li><a href="#tab-finish" data-toggle="tab" data-bind="click: finish">Finalize</a></li>
      <!-- /ko -->
      <li><input type="submit" value="Save" class="btn btn-success" data-bind="click: save" /></li>
    </ul>

    <div id="tab-contents" class="tab-content">

      <!-- Overview tab -->
      <div class="tab-pane active" id="tab-overview">
        <div class="row-fluid">
          <h2>Review</h2>

          <!-- Warnings -->
          <% if (@review.status == 'mailed') %>
            <div class="alert">
              This review has already been mailed and cannot be modified any more.
            </div>
          <% end %>

          <!-- Notes to grader -->
          <% unless @review.notes_to_grader.blank? %>
            <div class="alert alert-info">
              <%= @review.notes_to_grader %>
            </div>
          <% end %>

          <div class="span4 well">
            <!-- View submission -->
            <h3>Submission</h3>

            <% unless @review.submission.extension.blank? %>
              <%= link_to "#{@review.submission.filename}", @review.submission %>
              <small>(<%=l @review.submission.created_at %>)</small>
            <% end %>
          </div>
          <div class="span4 well">
            <!-- Group -->
            <h3>Group</h3>

            <table class="table">
              <tbody>
                <% @review.submission.group.users.each do |user| %>
                  <tr>
                    <td><%= user.studentnumber %></td>
                    <td><%= user.name %></td>
                    <td><%= user.email %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div> <!-- /tab-overview -->
      
      <!-- ko foreach: pages -->
        <div class="tab-pane" data-bind="attr: { id: 'page-' + id }">
          <h2 data-bind="text: name"></h2>

          <!-- ko if: finalizing -->
            <div class="alert alert-info">
              Individual pages cannot be edited because you are already finalizing the feedback. <button class="btn btn-small" data-bind="click: cancelFinalize">Cancel finalizing</button>
            </div>
          <!-- /ko -->
          
          <!-- Rubric -->
          <div class="rubric" data-bind="foreach: criteria, css: {compact: phrasesHidden}">
            <div class="criterion">
              <!-- Heading -->
              <h3>
                <span data-bind="text: name"></span>
                <!-- ko if: selectedPhrase() -->
                  <button data-bind="text: selectedPhrase().grade" type="button" class="btn highlighted"></button>
                <!-- /ko -->
              </h3>

              <!-- Phrases -->
              <div class="clear"></div>
              
              <div class="phrases">
                <table class="phrases">
                  <tbody data-bind="foreach: phrases">
                    <tr class="phrase">
                      <td class="grade" data-bind="if: grade">
                        <button data-bind="text: grade, click: clickGrade, css: { highlighted:  highlighted() }" type="button" class="btn"></button>
                      </td>
                      <td class="phrase" data-bind="html: escaped_content, click: clickPhrase"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <p><button class="btn btn-small" type="button" data-bind="click: togglePhraseVisibility">Show/Hide Phrases</button></p>
          
          <!-- Grades -->
          <div data-bind="if: $root.grades.length > 1">
            <p>
              <h3>Grade</h3>
              
              <p>
                <select data-bind="options: $root.grades, value: grade, attr: {disabled: finalizing}, optionsCaption: 'Choose grade...'"></select>
                <!-- ko if: averageGrade -->
                  <br />Calculated average is <strong data-bind="text: averageGrade"></strong>
                <!-- /ko -->
              </p>
            </p>
          </div>

          <!-- Textareas -->
          <div class="textareas" data-bind="foreach: feedback">
            <div>
              <p data-bind="text: title"></p>
              <textarea data-bind="value: value, attr: {disabled: $parent.finalizing}"></textarea>
            </div>
          </div>
        </div>
      <!-- /ko -->
      
      <!-- Finish tab -->
      <div class="tab-pane" id="tab-finish">
        <h2>Finalize Feedback</h2>
        
        <p class="hint">This is the final feedback text that is sent to the students by email.</p>
        
        <%= f.text_area :feedback, :style => "width: 600px; height: 600px;", 'data-bind' => "value: finishedText" %>
        
        <div data-bind="if: $root.grades.length > 1">
          <h3>Final Grade</h3>
          <select data-bind="options: $root.grades, value: finalGrade, optionsCaption: 'Choose grade...'"></select>
        </div>
        
        <p><button class="btn btn-success" data-bind="click: save">Save</button></p>
      </div>

    </div> <!-- /tab-contents -->
  </div> <!-- /tabbable -->
<% end %>

<p><%= link_to 'Back to menu', exercise_path(@exercise.id, :anchor => "group#{@review.submission.group.id}") %></p>
