<%= content_for :javascript do %>
  <%= javascript_include_tag 'annotationEditor' %>
<% end %>

<div class="annotation-editor" id="annotation-editor" data-rubric-url="<%= exercise_rubric_url(@exercise.id) %>" data-review-url="<%= review_url(@review.id) %>" data-submission-url="<%= submission_path(@submission.id, :format => 'png') %>" data-page-count="<%= @page_count %>">
  
  <div class="tabbable review-editor" id="review-editor">
    <div class="row-fluid">
      <ul id="tabs" class="nav nav-tabs">
        <!-- ko foreach: pages -->
          <li><a data-bind="text: name, attr:{ href: '#page-' + id, id: 'page-' + id + '-link' }" data-toggle='tab'></a></li>
        <!-- /ko -->
      </ul>
    </div>
    
    <div id="tab-contents" class="tab-content">
      <!-- ko foreach: pages -->
        <div class="tab-pane" data-bind="attr: { id: 'page-' + id }">
          <h2 data-bind="text: name"></h2>
          
          <!-- Rubric -->
          <div class="rubric" data-bind="foreach: criteria, css: {compact: phrasesHidden}">
            <div class="criterion">
              <!-- Heading -->
              <h3>
                <span data-bind="text: name"></span>
                <!-- ko if: selectedPhrase() -->
                  <button data-bind="text: selectedPhrase().grade" type="button" class="btn highlighted"></button>
                <!-- /ko -->
              </h3>

              <!-- Phrases -->
              <div class="clear"></div>
              
              <div class="phrases">
                <table class="phrases">
                  <tbody data-bind="foreach: phrases">
                    <tr class="phrase">
                      <td class="grade" data-bind="if: grade != undefined">
                        <button data-bind="text: grade, click: clickGrade, css: { highlighted:  highlighted() }" type="button" class="btn"></button>
                      </td>
                      <td class="phrase" data-bind="html: escaped_content, click: clickPhrase"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <p><button class="btn btn-small" type="button" data-bind="click: togglePhraseVisibility">Show/Hide Phrases</button></p>
          
          <!-- Grades -->
          <!-- ko if: $root.gradingMode == 'average' && $root.grades.length > 0 -->
            <hr />
            <h3>Grade</h3>
            
            <p>
              <select data-bind="options: $root.grades, value: grade, attr: {disabled: $root.finalizing}, optionsCaption: 'Choose grade...'"></select>
              <!-- ko if: averageGrade -->
                Calculated mean: <strong data-bind="text: averageGrade"></strong>
              <!-- /ko -->
            </p>
          <!-- /ko -->
          <!-- ko if: $root.gradingMode == 'sum' -->
            <hr />
            <h3>
              Points:
              <span data-bind="text: averageGrade"></span>
            </h3>
          <!-- /ko -->
          
          <!-- Next page button -->
          <!-- ko if: nextPage || $root.finishable() -->
            <button class="btn" data-bind="click: showNextPage">
              Next page
              <i class="icon icon-arrow-right"></i>
            </button>
          <!-- /ko -->
        </div>
      <!-- /ko -->

    </div> <!-- /tab-contents -->
  </div> <!-- /tabbable -->

  <!-- ko foreach: submission_pages -->
    <div class="submission-page">
      <img data-bind="attr: { src: src, alt: alt }, onload: onLoad" />
      
      <!-- ko foreach: annotations -->
        <div class="annotation" data-bind="text: content, position: screenPosition">
        </div>
      <!-- /ko -->
    </div>
  <!-- /ko -->
</div>
